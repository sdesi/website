---
// src/pages/projects/[slug].astro

import MainLayout from "../../layouts/MainLayout.astro";
import { projects } from "../../data/projects";

const base = import.meta.env.BASE_URL;

// динамические пути для Astro
export function getStaticPaths() {
  return projects.map((project) => ({
    params: { slug: project.slug },
  }));
}

const { slug } = Astro.params;
const project = projects.find((p) => p.slug === slug);

if (!project) {
  throw new Error(`Проект с slug "${slug}" не найден`);
}

const blocks = project.blocks ?? [];
---

<MainLayout title={project.title}>
  <a href={base} class="back">
    <span class="back-icon">
      <img src={`${base}icon-back.svg`} alt="" />
    </span>
    <span class="filter-toggle-label">
      Назад ко всем проектам
    </span>
  </a>

  {/* Превью-блок, как на главной */}
  <section class="project-hero">
    <article class="project-card project-card--hero">
      <div class="project-link project-link--hero">
        <div class="project-image-wrapper project-image-wrapper--hero">
          <img
            src={`${base}${project.cover}`}
            alt={project.title}
            class="project-block__image project-cover project-cover--hero"
          />
        </div>

        <div class="project-text project-text--hero">
          <div class="project-description">
            <img
              src={`${base}icon-info.svg`}
              alt=""
              class="project-info-icon"
            />
            {project.short}
          </div>
          <div class="project-title">
            {project.title}
          </div>
        </div>
      </div>
    </article>
  </section>

  {/* Блоки контента из projects.ts */}
  <section class="project-content">
  {blocks && blocks.length === 0 && (
    <p>
      Для этого проекта пока нет контент-блоков. Добавь массив{" "}
      <code>blocks</code> в <code>src/data/projects.ts</code>.
    </p>
  )}

  {blocks &&
    blocks.length > 0 &&
    blocks.map((block) => {
      if (block.type === "text") {
        return (
          <article class="project-block project-block--text">
            {block.title && (
              <h2 class="project-block__title">{block.title}</h2>
            )}
            <p class="project-block__text">{block.body}</p>
          </article>
        );
      }

      if (block.type === "image") {
        return (
          <figure class="project-block project-block--image">
            <img
              src={`${base}${block.src}`}
              alt={block.title ?? project.title}
              class="project-block__image"
            />
            {(block.title || block.caption) && (
              <figcaption class="project-block__caption">
                {block.title && (
                  <div class="project-block__caption-title">
                    {block.title}
                  </div>
                )}
                {block.caption && (
                  <div class="project-block__caption-text">
                    {block.caption}
                  </div>
                )}
              </figcaption>
            )}
          </figure>
        );
      }

      if (block.type === "wide-image") {
        // side: "left" | "right" | "center" | undefined
        // по умолчанию (undefined) — ПРАВЫЙ вылет
        const side = block.side ?? "right";

        return (
          <figure
            class={`project-block project-block--image project-block--wide project-block--wide-${side}`}
          >
            <div
              class="project-block-wide__scroller"
              data-side={side}
            >
              <img
                src={`${base}${block.src}`}
                alt={block.title ?? project.title}
                class="project-block-wide__image"
              />
            </div>

            {(block.title || block.caption) && (
              <figcaption class="project-block__caption">
                {block.title && (
                  <div class="project-block__caption-title">
                    {block.title}
                  </div>
                )}
                {block.caption && (
                  <div class="project-block__caption-text">
                    {block.caption}
                  </div>
                )}
              </figcaption>
            )}
          </figure>
        );
      }

      return null;
    })}
</section>

  <script is:inline>
    function updateProjectImageHeight() {
      // Берём первую обычную картинку проекта как эталон
      const square = document.querySelector(".project-block__image");
      if (!square) return;

      // Для квадратных: ширина = высота → берём ширину
      const size = square.clientWidth;

      // Эту высоту задаём всем картинкам проекта
      document.documentElement.style.setProperty(
        "--project-image-height",
        size + "px"
      );
    }

    function setupWideBlocks(options) {
      const { resetMobileScroll } = options || {};
      const isDesktop = window.innerWidth >= 769;

      document
  .querySelectorAll(".project-block-wide__scroller")
  .forEach((el) => {
    const img = el.querySelector(".project-block-wide__image");
    if (!img) return;

    img.style.transform = "";

    const side = el.getAttribute("data-side") || "right";

    // НОВОЕ: center — никуда не вылезает и не скроллится
    if (side === "center") {
      if (!isDesktop && resetMobileScroll) {
        el.scrollLeft = 0; // на мобиле просто в нуле
      }
      return;
    }

    if (!isDesktop) {
      if (resetMobileScroll) {
        const maxScroll = el.scrollWidth - el.clientWidth;
        if (maxScroll > 0) {
          el.scrollLeft = side === "right" ? 0 : maxScroll;
        }
      }
      return;
    }

    // ДЕСКТОП: вылет только для left/right
    const containerWidth = el.clientWidth;
    const imgWidth = img.clientWidth;

    if (imgWidth <= containerWidth) return;

    if (side === "right") {
      img.style.transform = "translateX(0)";
    } else {
      const shift = containerWidth - imgWidth;
      img.style.transform = `translateX(${shift}px)`;
    }
  });

    }

    window.addEventListener("load", () => {
      updateProjectImageHeight();
      // при первом заходе:
      // — считаем высоту
      // — задаём стартовый скролл для мобилы
      setupWideBlocks({ resetMobileScroll: true });
    });

    window.addEventListener("resize", () => {
      updateProjectImageHeight();
      // при ресайзе:
      // — высоту обновляем
      // — НО scrollLeft на мобиле НЕ трогаем, чтобы не сбрасывать руками юзера
      setupWideBlocks({ resetMobileScroll: false });
    });
  </script>
</MainLayout>

